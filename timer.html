<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Timer</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#111827;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#22c55e;
      --danger:#ef4444;
      --warn:#f59e0b;
      --barbg:#1f2937;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:radial-gradient(1200px 600px at 50% 20%, rgba(34,197,94,.18), transparent 60%),
                 radial-gradient(900px 500px at 20% 80%, rgba(245,158,11,.12), transparent 55%),
                 var(--bg);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .wrap{
      width:min(680px, 100%);
      background:rgba(17,24,39,.85);
      border:1px solid rgba(255,255,255,.08);
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      border-radius:16px;
      padding:22px 18px 18px;
      position:relative;
      overflow:hidden;
    }
    .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    .status{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      font-weight:700;
      letter-spacing:.5px;
      width:fit-content;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background:var(--muted);
      box-shadow:0 0 0 4px rgba(156,163,175,.18);
    }
    .meta{
      color:var(--muted);
      font-size:14px;
      line-height:1.25;
      max-width: 320px;
    }
    .time{
      font-variant-numeric: tabular-nums;
      font-size: clamp(56px, 10vw, 92px);
      font-weight: 800;
      letter-spacing: -1px;
      text-align:right;
      min-width: 180px;
    }
    .progress{
      height:12px;
      background:var(--barbg);
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
      margin: 14px 0 12px;
    }
    .bar{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(34,197,94,.95), rgba(245,158,11,.90));
      border-radius:999px;
      transition: width .15s linear;
    }
    .controls{
      display:flex;
      gap:10px;
      margin-top:10px;
    }
    button{
      appearance:none;
      border:none;
      border-radius:12px;
      padding:12px 14px;
      font-weight:700;
      cursor:pointer;
      color:var(--text);
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      flex:1;
      transition: transform .05s ease, background .15s ease;
    }
    button:hover{ background:rgba(255,255,255,.09); }
    button:active{ transform: translateY(1px); }
    .btn-primary{
      background:rgba(34,197,94,.18);
      border-color:rgba(34,197,94,.35);
    }
    .btn-warn{
      background:rgba(245,158,11,.16);
      border-color:rgba(245,158,11,.35);
    }
    .err{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(239,68,68,.35);
      background:rgba(239,68,68,.10);
      color:#fecaca;
      font-size:14px;
      display:none;
      white-space:pre-wrap;
    }
    .brand{
      position:absolute;
      right:14px;
      bottom:10px;
      color:rgba(229,231,235,.60);
      font-size:13px;
      font-weight:700;
      letter-spacing:.2px;
      user-select:none;
    }
    .hint{
      color:rgba(156,163,175,.75);
      font-size:12px;
      margin-top:6px;
      text-align:center;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="status">
        <div class="badge" id="phaseBadge">
          <span class="dot" id="phaseDot"></span>
          <span id="phaseText">PRÊT</span>
        </div>
        <div class="meta" id="metaLine">—</div>
      </div>
      <div class="time" id="timeDisplay">00:00</div>
    </div>

    <div class="progress" aria-label="Progression">
      <div class="bar" id="progressBar"></div>
    </div>

    <div class="controls">
      <button class="btn-primary" id="resetBtn" type="button">Reset</button>
      <button class="btn-warn" id="skipBtn" type="button">Skip</button>
    </div>

    <div class="hint" id="hintLine">prep → durée → fin</div>
    <div class="err" id="errBox"></div>

    <div class="brand">Coach Simon</div>
  </div>

<script>
(function(){
  const qs = new URLSearchParams(window.location.search);

  // Params
  const prep = toInt(qs.get('prep'), 0);             // secondes (>=0)
  const dur  = toInt(qs.get('dur'), null);           // secondes (>0) requis
  const mode = (qs.get('mode') || 'work').trim();    // work|rest (label only)
  const startStr = (qs.get('start') || '').trim();   // optionnel (ISO ou DD/MM/YYYY HH:mm:ss)
  const tz   = (qs.get('tz') || '').trim();          // optionnel (affichage meta)
  const vib  = parseBool(qs.get('vib'), true);       // optionnel: vib=0 pour couper

  const errBox = el('errBox');
  const phaseText = el('phaseText');
  const phaseDot  = el('phaseDot');
  const metaLine  = el('metaLine');
  const timeDisplay = el('timeDisplay');
  const progressBar = el('progressBar');

  const resetBtn = el('resetBtn');
  const skipBtn  = el('skipBtn');
  const hintLine = el('hintLine');

  // Validation
  const problems = [];
  if (prep < 0) problems.push("Paramètre invalide : prep (>= 0)");
  if (dur === null || dur <= 0) problems.push("Paramètre requis invalide : dur (secondes, > 0)");

  if (problems.length){
    showError(
      "❌ URL invalide.\n" +
      problems.map(p=>"• "+p).join("\n") +
      "\n\nExemple : timer.html?prep=10&dur=75&tz=Europe/Paris&cb=123"
    );
    setPhase("ERREUR", "danger");
    timeDisplay.textContent = "—";
    metaLine.textContent = "Corrige les paramètres URL.";
    progressBar.style.width = "0%";
    resetBtn.disabled = true;
    skipBtn.disabled = true;
    hintLine.textContent = "prep → durée → fin";
    return;
  }

  // --- Wake Lock (écran allumé) ---
  let wakeLock = null;
  async function requestWakeLock() {
    try {
      if ('wakeLock' in navigator && !wakeLock) {
        wakeLock = await navigator.wakeLock.request('screen');
        wakeLock.addEventListener?.('release', () => { wakeLock = null; });
      }
    } catch (e) {}
  }
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible' && !wakeLock) requestWakeLock();
  });

  // --- Audio unlock (iOS/Chrome policies) ---
  let audioCtx = null;
  async function unlockAudio(){
    try{
      const C = window.AudioContext || window.webkitAudioContext;
      if (!C) return;
      if (!audioCtx) audioCtx = new C();
      if (audioCtx.state === 'suspended') await audioCtx.resume();
    }catch(e){}
  }
  function oneTapUnlock(){
    unlockAudio();
    requestWakeLock();
  }
  window.addEventListener('pointerdown', oneTapUnlock, { once:true });
  window.addEventListener('touchstart', oneTapUnlock, { once:true });

  // --- Beep & vibrate ---
  function beep(freq=1200, ms=110, vol=0.12){
    try{
      const C = window.AudioContext || window.webkitAudioContext;
      if (!C) return;
      if (!audioCtx) audioCtx = new C();
      if (audioCtx.state === 'suspended') return; // sera débloqué au tap
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'sine';
      o.frequency.value = freq;
      g.gain.value = vol;
      o.connect(g); g.connect(audioCtx.destination);
      o.start();
      setTimeout(()=>{ try{o.stop();}catch{} }, ms);
    }catch(e){}
  }
  function buzz(ms=60){
    if (!vib) return;
    try{ if (navigator.vibrate) navigator.vibrate(ms); }catch(e){}
  }

  // --- Time model ---
  const totalSeconds = prep + dur;

  // startMs : permet de synchroniser si start est passé
  let startMs = parseStart(startStr);

  // State
  const PHASE = { PREP:"PREP", RUN:"RUN", DONE:"DONE" };
  let phase = (prep > 0) ? PHASE.PREP : PHASE.RUN;

  // For 3-2-1 beeps once per second
  let lastPrepDisp = null;
  let lastRunDisp  = null;

  // First render
  renderFrame();

  // Timer loop
  const iv = setInterval(tick, 100);

  resetBtn.addEventListener('click', ()=>{
    oneTapUnlock();
    // reset = redémarre proprement
    window.location.reload();
  });

  skipBtn.addEventListener('click', ()=>{
    oneTapUnlock();
    const now = Date.now();
    if (phase === PHASE.PREP){
      // saute prep => on met startMs comme si prep était déjà passé
      startMs = now - (prep * 1000) - 10;
    } else if (phase === PHASE.RUN){
      // saute run => fin
      startMs = now - ((prep + dur) * 1000) - 10;
    }
    renderFrame();
  });

  function tick(){
    renderFrame();
  }

  function renderFrame(){
    const now = Date.now();
    const elapsed = (now - startMs) / 1000;

    const prepRemain = Math.max(0, prep - elapsed);
    const runRemain  = Math.max(0, (prep + dur) - elapsed);

    // Progress (0..1)
    const totalRemaining = (prep > 0 && prepRemain > 0) ? (prepRemain + dur) : runRemain;
    const progress = totalSeconds > 0 ? (1 - (totalRemaining / totalSeconds)) : 1;
    progressBar.style.width = (Math.max(0, Math.min(1, progress)) * 100).toFixed(2) + "%";

    // --- PREP ---
    if (prep > 0 && prepRemain > 0){
      phase = PHASE.PREP;
      setPhase("PRÊT", "warn");
      metaLine.textContent = metaText("Décompte", prep, dur, tz);
      const disp = Math.ceil(prepRemain);
      timeDisplay.textContent = formatMMSS(disp);

      // Beeps + vibrations sur 3-2-1 du décompte
      if (disp !== lastPrepDisp){
        if (disp === 3 || disp === 2 || disp === 1){
          beep(1100, 110, 0.14);
          buzz(70);
        }
        lastPrepDisp = disp;
      }
      return;
    }

    // --- RUN ---
    if (runRemain > 0){
      phase = PHASE.RUN;
      const label = (mode === 'rest') ? "RÉCUP" : "DURÉE";
      setPhase(label, "accent");
      metaLine.textContent = metaText(label, prep, dur, tz);

      const disp = Math.ceil(runRemain);
      timeDisplay.textContent = formatMMSS(disp);

      // Beeps + vibrations sur 3-2-1 du minuteur
      if (disp !== lastRunDisp){
        if (disp === 3 || disp === 2 || disp === 1){
          beep(1300, 110, 0.14);
          buzz(70);
        }
        lastRunDisp = disp;
      }
      return;
    }

    // --- DONE ---
    if (phase !== PHASE.DONE){
      phase = PHASE.DONE;
      clearInterval(iv);
    }
    setPhase("FIN", "accent");
    phaseDot.style.boxShadow = "0 0 0 6px rgba(34,197,94,.18)";
    timeDisplay.textContent = "00:00";
    metaLine.textContent = "Terminé";
    progressBar.style.width = "100%";
  }

  function metaText(mainLabel, prepSec, durSec, tzStr){
    const base = `prep ${prepSec}s • dur ${durSec}s`;
    const tzPart = tzStr ? ` • ${tzStr}` : "";
    return `${mainLabel} — ${base}${tzPart}`;
  }

  function setPhase(label, kind){
    phaseText.textContent = label;
    if (kind === "accent"){
      phaseDot.style.background = "var(--accent)";
      phaseDot.style.boxShadow = "0 0 0 4px rgba(34,197,94,.18)";
    } else if (kind === "warn"){
      phaseDot.style.background = "var(--warn)";
      phaseDot.style.boxShadow = "0 0 0 4px rgba(245,158,11,.18)";
    } else if (kind === "danger"){
      phaseDot.style.background = "var(--danger)";
      phaseDot.style.boxShadow = "0 0 0 4px rgba(239,68,68,.18)";
    } else {
      phaseDot.style.background = "var(--muted)";
      phaseDot.style.boxShadow = "0 0 0 4px rgba(156,163,175,.18)";
    }
  }

  function parseStart(s){
    if (!s) return Date.now();
    const d = new Date(s);
    if (!isNaN(d)) return d.getTime();
    const m = s.match(/(\d{2})\/(\d{2})\/(\d{4})\s+(\d{2}):(\d{2}):(\d{2})/);
    if (m){
      const [,dd,MM,yyyy,hh,mm,ss] = m;
      return new Date(`${yyyy}-${MM}-${dd}T${hh}:${mm}:${ss}`).getTime();
    }
    return Date.now();
  }

  function el(id){ return document.getElementById(id); }
  function toInt(v, fallback){
    if (v === null || v === undefined || v === "") return fallback;
    const n = parseInt(String(v), 10);
    return Number.isFinite(n) ? n : fallback;
  }
  function parseBool(v, fallback){
    if (v === null || v === undefined || v === "") return fallback;
    const s = String(v).toLowerCase().trim();
    if (s === "0" || s === "false" || s === "no") return false;
    if (s === "1" || s === "true"  || s === "yes") return true;
    return fallback;
  }
  function formatMMSS(total){
    const t = Math.max(0, total|0);
    const mm = String(Math.floor(t/60)).padStart(2,'0');
    const ss = String(t%60).padStart(2,'0');
    return `${mm}:${ss}`;
  }
  function showError(msg){
    errBox.style.display = "block";
    errBox.textContent = msg;
  }
})();
</script>
</body>
</html>
